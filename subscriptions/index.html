<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Tracker</title>
    <link rel="stylesheet" href="css/subscriptions.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <h1>Subscription Tracker</h1>
            <div id="user-info" class="user-info" style="display: none;">
                <img id="user-avatar" class="user-avatar" src="" alt="User" style="display: none;">
                <span id="user-name" class="user-name"></span>
                <button id="sign-out-btn" class="btn btn-secondary">Sign Out</button>
            </div>
        </header>

        <!-- Authentication Section -->
        <section id="auth-section" class="auth-section">
            <div class="auth-card">
                <h2>Welcome to Subscription Tracker</h2>
                <p>Track all your subscriptions in one place. Sign in to get started.</p>

                <!-- Email Sign In Form -->
                <form id="email-auth-form" class="email-auth-form">
                    <div class="auth-tabs">
                        <button type="button" class="auth-tab active" data-tab="signin">Sign In</button>
                        <button type="button" class="auth-tab" data-tab="signup">Sign Up</button>
                    </div>

                    <div id="auth-error" class="auth-error" style="display: none;"></div>

                    <div class="form-group">
                        <label for="auth-email">Email</label>
                        <input type="email" id="auth-email" required placeholder="you@example.com">
                    </div>

                    <div class="form-group">
                        <label for="auth-password">Password</label>
                        <input type="password" id="auth-password" required placeholder="••••••••" minlength="6">
                    </div>

                    <button type="submit" id="email-auth-btn" class="btn btn-primary" style="width: 100%;">
                        Sign In
                    </button>
                </form>

                <div class="auth-divider">
                    <span>OR</span>
                </div>

                <button id="sign-in-btn" class="btn btn-secondary" style="width: 100%;">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.64 9.20443C17.64 8.56625 17.5827 7.95262 17.4764 7.36353H9V10.8449H13.8436C13.635 11.9699 13.0009 12.9231 12.0477 13.5613V15.8194H14.9564C16.6582 14.2526 17.64 11.9453 17.64 9.20443Z" fill="#4285F4"/>
                        <path d="M8.99976 18C11.4298 18 13.467 17.1941 14.9561 15.8195L12.0475 13.5613C11.2416 14.1013 10.2107 14.4204 8.99976 14.4204C6.65567 14.4204 4.67158 12.8372 3.96385 10.71H0.957031V13.0418C2.43794 15.9831 5.48158 18 8.99976 18Z" fill="#34A853"/>
                        <path d="M3.96409 10.7098C3.78409 10.1698 3.68182 9.59301 3.68182 8.99983C3.68182 8.40665 3.78409 7.82983 3.96409 7.28983V4.95801H0.957273C0.347727 6.17301 0 7.54756 0 8.99983C0 10.4521 0.347727 11.8266 0.957273 13.0416L3.96409 10.7098Z" fill="#FBBC05"/>
                        <path d="M8.99976 3.57955C10.3211 3.57955 11.5075 4.03364 12.4402 4.92545L15.0216 2.34409C13.4629 0.891818 11.4257 0 8.99976 0C5.48158 0 2.43794 2.01682 0.957031 4.95818L3.96385 7.29C4.67158 5.16273 6.65567 3.57955 8.99976 3.57955Z" fill="#EA4335"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
        </section>

        <!-- Main App Section -->
        <section id="app-section" class="app-section" style="display: none;">
            <!-- Dashboard Summary -->
            <div class="dashboard">
                <div class="stat-card">
                    <h3>Active Subscriptions</h3>
                    <p id="active-count" class="stat-value">0</p>
                </div>
                <div class="stat-card">
                    <h3>Monthly Total</h3>
                    <p id="total-monthly" class="stat-value">$0.00</p>
                </div>
                <div class="stat-card">
                    <h3>Yearly Total</h3>
                    <p id="total-yearly" class="stat-value">$0.00</p>
                </div>
            </div>

            <!-- Subscriptions List -->
            <div class="subscriptions-container">
                <div class="subscriptions-header">
                    <h2>Your Subscriptions</h2>
                    <button id="add-subscription-btn" class="btn btn-primary">+ Add Subscription</button>
                </div>
                <div id="subscriptions-list" class="subscriptions-list">
                    <!-- Subscriptions will be rendered here -->
                </div>
            </div>
        </section>

        <!-- Slide-out Form Overlay -->
        <div id="form-overlay" class="form-overlay">
            <div id="form-slider" class="form-slider">
                <div class="form-slider-header">
                    <h2 id="form-title">Add Subscription</h2>
                    <button id="close-form-btn" class="btn-close" type="button">&times;</button>
                </div>
                <form id="subscription-form" class="form-slider-body">
                    <input type="hidden" id="subscription-id" value="">

                    <div class="form-group">
                        <label for="name">Service Name *</label>
                        <input type="text" id="name" name="name" required placeholder="Netflix, Spotify, etc.">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cost">Cost *</label>
                            <input type="number" id="cost" name="cost" step="0.01" min="0" required placeholder="9.99">
                        </div>

                        <div class="form-group">
                            <label for="currency">Currency</label>
                            <select id="currency" name="currency">
                                <option value="USD">USD ($)</option>
                                <option value="EUR">EUR (€)</option>
                                <option value="GBP">GBP (£)</option>
                                <option value="CAD">CAD ($)</option>
                                <option value="AUD">AUD ($)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="billing-cycle">Billing Cycle *</label>
                            <select id="billing-cycle" name="billing-cycle" required>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="next-billing-date">Next Billing Date</label>
                            <input type="date" id="next-billing-date" name="next-billing-date">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category" name="category">
                            <option value="">Select category</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Productivity">Productivity</option>
                            <option value="Storage">Storage</option>
                            <option value="Music">Music</option>
                            <option value="Gaming">Gaming</option>
                            <option value="Education">Education</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="description">Notes</label>
                        <textarea id="description" name="description" rows="3" placeholder="Optional notes about this subscription"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" id="submit-btn" class="btn btn-primary">Add Subscription</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- App Scripts -->
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/subscriptions.js"></script>

    <!-- Main App Script -->
    <script>
        let currentAuthMode = 'signin'; // 'signin' or 'signup'

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize auth manager
            await window.authManager.init();

            // Setup auth tab switching
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    currentAuthMode = e.target.dataset.tab;

                    const btn = document.getElementById('email-auth-btn');
                    btn.textContent = currentAuthMode === 'signin' ? 'Sign In' : 'Sign Up';

                    // Clear any errors
                    const errorDiv = document.getElementById('auth-error');
                    errorDiv.style.display = 'none';
                });
            });

            // Setup email auth form submission
            document.getElementById('email-auth-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const errorDiv = document.getElementById('auth-error');
                const submitBtn = document.getElementById('email-auth-btn');

                // Disable button and show loading state
                submitBtn.disabled = true;
                submitBtn.textContent = currentAuthMode === 'signin' ? 'Signing in...' : 'Signing up...';
                errorDiv.style.display = 'none';

                let result;
                if (currentAuthMode === 'signin') {
                    result = await window.authManager.signInWithEmail(email, password);
                } else {
                    result = await window.authManager.signUpWithEmail(email, password);
                }

                if (result.success) {
                    // Clear form
                    document.getElementById('email-auth-form').reset();

                    if (currentAuthMode === 'signup') {
                        errorDiv.textContent = 'Account created successfully! You are now signed in.';
                        errorDiv.style.display = 'block';
                        errorDiv.style.color = '#10b981';
                    }
                } else {
                    // Show error
                    errorDiv.textContent = result.error;
                    errorDiv.style.display = 'block';
                    errorDiv.style.color = '#ef4444';
                }

                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = currentAuthMode === 'signin' ? 'Sign In' : 'Sign Up';
            });

            // Setup event listeners
            document.getElementById('sign-in-btn').addEventListener('click', async () => {
                await window.authManager.signInWithGoogle();
            });

            document.getElementById('sign-out-btn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to sign out?')) {
                    await window.authManager.signOut();
                    window.subscriptionManager.cleanup();
                }
            });

            // Form overlay handlers
            const formOverlay = document.getElementById('form-overlay');
            const formSlider = document.getElementById('form-slider');
            const addBtn = document.getElementById('add-subscription-btn');
            const closeFormBtn = document.getElementById('close-form-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const formTitle = document.getElementById('form-title');

            function openForm(isEdit = false) {
                formOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                if (!isEdit) {
                    formTitle.textContent = 'Add Subscription';
                }
            }

            function closeForm() {
                formOverlay.classList.remove('active');
                document.body.style.overflow = '';
                // Reset form
                document.getElementById('subscription-form').reset();
                document.getElementById('subscription-id').value = '';
                document.getElementById('submit-btn').textContent = 'Add Subscription';
                formTitle.textContent = 'Add Subscription';
            }

            addBtn.addEventListener('click', () => openForm());
            closeFormBtn.addEventListener('click', closeForm);
            cancelBtn.addEventListener('click', closeForm);

            // Close on overlay click
            formOverlay.addEventListener('click', (e) => {
                if (e.target === formOverlay) {
                    closeForm();
                }
            });

            // Expose closeForm globally for edit functionality
            window.openSubscriptionForm = openForm;
            window.closeSubscriptionForm = closeForm;

            // Setup form submission
            document.getElementById('subscription-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    name: document.getElementById('name').value.trim(),
                    cost: parseFloat(document.getElementById('cost').value),
                    currency: document.getElementById('currency').value,
                    billing_cycle: document.getElementById('billing-cycle').value,
                    next_billing_date: document.getElementById('next-billing-date').value || null,
                    category: document.getElementById('category').value || null,
                    description: document.getElementById('description').value.trim() || null,
                    active: true
                };

                const subscriptionId = document.getElementById('subscription-id').value;

                let result;
                if (subscriptionId) {
                    // Update existing subscription
                    result = await window.subscriptionManager.updateSubscription(subscriptionId, formData);
                } else {
                    // Add new subscription
                    result = await window.subscriptionManager.addSubscription(formData);
                }

                if (result.success) {
                    // Close the form
                    closeForm();
                } else {
                    alert('Error: ' + result.error);
                }
            });

            // Track if subscription manager has been initialized
            let subscriptionManagerInitialized = false;

            // Listen for auth state changes and initialize subscription manager
            window.authManager.onAuthStateChange(async (user) => {
                if (user) {
                    if (!subscriptionManagerInitialized) {
                        await window.subscriptionManager.init();
                        subscriptionManagerInitialized = true;
                    }
                } else {
                    window.subscriptionManager.cleanup();
                    window.subscriptionManager.subscriptions = [];
                    window.subscriptionManager.render();
                    subscriptionManagerInitialized = false;
                }
            });

            // Check after auth init completes and init if user exists
            if (window.authManager.currentUser && !subscriptionManagerInitialized) {
                await window.subscriptionManager.init();
                subscriptionManagerInitialized = true;
            }
        });
    </script>
</body>
</html>
